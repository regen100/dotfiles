#!/bin/bash

if [[ ! -f $1 ]]; then
  exit 1
fi

mime_inner=$(file -Lbz --mime-type "$1")
mime_outer=$(file -Lb --mime-type "$1")
case $mime_inner in
  text/x-shellscript) lexer=sh;;
  application/xml) lexer=xml;;
  text/*) lexer=;;
  *)
    # binary
    case $mime_outer in
      application/x-executable) exec objdump -x "$1";;
    esac
    exit 1
    ;;
esac

case $mime_outer in
  application/x-gzip | application/gzip) concat=zcat;;
  application/x-bzip2) concat=bzcat;;
  application/x-xz) concat=xzcat;;
  application/x-lz4) concat=lz4cat;;
  $mime_inner) concat=cat;;
  *) exit 1;;
esac

if [[ $1 = *.log || $1 = *.log.* ]]; then
  exec $concat "$1" | ccze -A
fi

if [[ $concat != cat && -z $lexer ]]; then
  lexer=$(pygmentize -N "${1%.*}")
fi

style=base16-${BASE16_THEME#base16-}
if [[ -n $lexer ]]; then
  exec $concat "$1" | pygmentize -f 256 -O style="$style" -l "$lexer" 2>/dev/null
else
  exec pygmentize -f 256 -O style="$style" "$1" 2>/dev/null
fi

exit 1
